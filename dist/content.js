!function(){const e="easyerp_credentials",o="easyerp_session_data";function initializeSessionKeepAlive(){console.log("⏰ Initializing session keep-alive..."),!function(){const e=['a[href*="logout"]',".logout","#logout",'[title*="logout"]',".user-menu",".dashboard",".user-profile",".main-content",".navigation-menu",'[href*="dashboard"]'];for(const o of e)if(document.querySelector(o))return console.log(`🔍 Found logged-in indicator: ${o}`),!0;const o=["/dashboard","/home","/main","/portal"],n=window.location.pathname.toLowerCase();for(const e of o)if(n.includes(e))return console.log(`🔍 Found logged-in URL pattern: ${e}`),!0;return!1}()?console.log("🔓 User not logged in, session keep-alive not needed"):(console.log("✅ User is logged in, starting session maintenance"),function(){console.log("🔄 Starting session maintenance...");const e=setInterval(()=>{performKeepAliveAction()},3e5);let o;const resetActivityTimer=()=>{clearTimeout(o),o=setTimeout(()=>{console.log("👆 User activity detected, refreshing session"),performKeepAliveAction()},12e4)};["mousedown","mousemove","keypress","scroll","touchstart","click"].forEach(e=>{document.addEventListener(e,resetActivityTimer,{passive:!0})}),performKeepAliveAction(),window.erpSessionInterval=e,console.log("✅ Session keep-alive activated")}(),updateSessionTimestamp())}function performKeepAliveAction(){console.log("📡 Performing keep-alive ping...");try{fetch(window.location.origin+"/api/ping",{method:"GET",credentials:"include",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>{e.ok?(console.log("✅ Keep-alive ping successful"),updateSessionTimestamp()):(console.log("⚠️ Keep-alive ping failed, trying alternative method"),alternativeKeepAlive())}).catch(()=>{console.log("⚠️ Keep-alive ping failed, trying alternative method"),alternativeKeepAlive()})}catch(e){console.log("⚠️ Keep-alive ping error, trying alternative method"),alternativeKeepAlive()}}function alternativeKeepAlive(){try{const e=document.createElement("iframe");e.style.display="none",e.style.width="1px",e.style.height="1px",e.src=window.location.href+"?keepalive="+Date.now(),e.onload=()=>{console.log("✅ Alternative keep-alive successful"),document.body.removeChild(e),updateSessionTimestamp()},e.onerror=()=>{console.log("⚠️ Alternative keep-alive failed"),document.body.removeChild(e)},document.body.appendChild(e),setTimeout(()=>{e.parentNode&&document.body.removeChild(e)},1e4)}catch(e){console.log("❌ All keep-alive methods failed:",e)}}function updateSessionTimestamp(){const e={lastActivity:Date.now(),url:window.location.href,timestamp:(new Date).toISOString()};chrome.storage.local.set({[o]:e},()=>{chrome.runtime.lastError||console.log("💾 Session timestamp updated")})}function createLoginPrompt(){if(console.log("📝 Prompting for credentials..."),!window.location.href.includes("erp.iitkgp.ac.in"))return void console.log("❌ Not on ERP site, skipping credential prompt");const o=prompt("🔐 EasyERP AutoLogin\n\nEnter your Login ID:");if(!o)return void console.log("❌ No login ID provided, cancelling setup");const n=prompt("🔐 EasyERP AutoLogin\n\nEnter your Password:");if(!n)return void console.log("❌ No password provided, cancelling setup");const t={},i=prompt("🔐 EasyERP AutoLogin\n\nEnter your FIRST security question:");if(!i)return void console.log("❌ No security questions provided, cancelling setup");const s=prompt(`🔐 EasyERP AutoLogin\n\nAnswer to: "${i}"`);if(!s)return void console.log("❌ No answer provided, cancelling setup");t[i]=s;const l=prompt("🔐 EasyERP AutoLogin\n\nEnter your SECOND security question:");if(!l)return void console.log("❌ No second security question provided, cancelling setup");const r=prompt(`🔐 EasyERP AutoLogin\n\nAnswer to: "${l}"`);if(!r)return void console.log("❌ No answer provided, cancelling setup");t[l]=r;const a=prompt("🔐 EasyERP AutoLogin\n\nEnter your THIRD security question:");if(!a)return void console.log("❌ No third security question provided, cancelling setup");const c=prompt(`🔐 EasyERP AutoLogin\n\nAnswer to: "${a}"`);if(!c)return void console.log("❌ No answer provided, cancelling setup");t[a]=c;const u={loginId:o,password:n,questions:t};console.log("💾 Saving credentials to storage..."),chrome.storage.local.set({[e]:u},()=>{chrome.runtime.lastError?(console.error("❌ Error saving credentials:",chrome.runtime.lastError),alert("❌ Error saving credentials. Please try again.")):(console.log("✅ Credentials saved successfully!"),alert("✅ Credentials saved! Please reload the page to start auto-login."))})}function initializeExtension(){console.log("🔍 Checking for stored credentials..."),chrome.storage.local.get([e],o=>{chrome.runtime.lastError?console.error("❌ Error accessing storage:",chrome.runtime.lastError):(console.log("📦 Storage result:",o),o[e]&&0!==Object.keys(o[e]||{}).length?(console.log("✅ Credentials found, starting auto-login..."),console.log("🔑 Stored credentials:",{loginId:o[e].loginId?"***":"missing",password:o[e].password?"***":"missing",questions:Object.keys(o[e].questions||{}).length+" questions"}),setTimeout(()=>{!function(o){console.log("🚀 Starting auto-login process...");const n=document.querySelector('input[name="user_id"]'),t=document.querySelector('input[name="password"]'),i=document.querySelector('input[name="email_otp"]');if(!n||!t)return console.error("❌ Login or password field not found on page"),void console.log("🔍 Available input fields:",document.querySelectorAll("input"));console.log("✅ Login fields found, proceeding with auto-fill"),console.log("👤 Step 1: Filling login ID..."),n.focus(),n.value=o.loginId,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),setTimeout(()=>{console.log("🔑 Step 2: Filling password..."),t.focus(),t.value=o.password,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.blur(),console.log("❓ Step 3: Waiting for security question to appear...");const n=new MutationObserver(()=>{const t=document.querySelector('input[name="answer"]'),s=document.querySelector("label#question");if(t&&s&&null!==t.offsetParent){const l=s.textContent.trim(),r=o.questions[l];if(!r){console.warn("⚠️ No answer found for question:",l);const n=prompt(`❓ Security Question:\n\n${l}\n\nPlease provide the answer:`);n&&(o.questions[l]=n,chrome.storage.local.set({[e]:o})),r=n}if(r){console.log(`✅ Step 4: Filling security answer for: ${l}`),t.focus(),t.value=r,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.blur(),n.disconnect();const e=document.querySelector("#getotp");e?(console.log("📱 Step 5: Clicking Send OTP..."),e.click()):console.warn("⚠️ Send OTP button not found"),setTimeout(()=>{const e=prompt("📱 EasyERP AutoLogin\n\nStep 6: Enter the 6-digit OTP sent to your email:");if(i&&e){console.log("🔢 Step 7: Filling OTP..."),i.value=e,i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}));const o=document.querySelector("#loginFormSubmitButton");o?(console.log("🚀 Step 8: Clicking Login button..."),o.click(),setTimeout(()=>{console.log("⏰ Setting up post-login session management..."),initializeSessionKeepAlive()},3e3)):console.warn("⚠️ Login submit button not found")}else console.log("❌ OTP entry cancelled or field not found")},2e3)}}});n.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{n.disconnect(),console.log("⏰ Security question observer timed out after 30 seconds")},3e4)},1200)}(o[e])},500)):(console.log("📝 No credentials found, prompting user..."),setTimeout(()=>{createLoginPrompt()},1e3)))})}console.log("🚀 EasyERP AutoLogin script loaded!"),window.EasyERPAutoLogin={setupCredentials:createLoginPrompt,clearCredentials:()=>{chrome.storage.local.remove([e],()=>{console.log("🗑️ Credentials cleared!"),alert("Credentials cleared! Reload page to set up new credentials.")})},viewCredentials:()=>{chrome.storage.local.get([e],o=>{o[e]?console.log("🔑 Current credentials:",{loginId:o[e].loginId,password:"***HIDDEN***",questions:o[e].questions}):console.log("❌ No credentials stored")})}},console.log("🎮 Debug commands available:"),console.log("- EasyERPAutoLogin.setupCredentials() - Setup new credentials"),console.log("- EasyERPAutoLogin.clearCredentials() - Clear stored credentials"),console.log("- EasyERPAutoLogin.viewCredentials() - View current credentials"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeExtension):initializeExtension()}();