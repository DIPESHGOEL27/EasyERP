!function(){const e="easyerp_credentials",o="easyerp_session_data";function initializeSessionKeepAlive(){console.log("â° Initializing session keep-alive..."),setTimeout(()=>{checkIfLoggedIn()?(console.log("âœ… User is logged in, starting session maintenance"),function(){console.log("ðŸ”„ Starting session maintenance...");const e=setInterval(()=>{performKeepAliveAction()},18e4),o=setInterval(()=>{checkIfLoggedIn()||(console.warn("âš ï¸ Session lost detected! User may have been logged out."),clearInterval(e),clearInterval(o),clearInterval(window.erpSessionInterval),window.location.href.includes("erp.iitkgp.ac.in")&&!window.location.href.includes("menulist.htm")&&(console.log("ðŸ”„ Detected login page, attempting re-authentication..."),setTimeout(()=>{initializeExtension()},2e3)))},3e4);let n;const resetActivityTimer=()=>{clearTimeout(n),n=setTimeout(()=>{console.log("ðŸ‘† User activity detected, refreshing session"),performKeepAliveAction()},9e4)};["mousedown","mousemove","keypress","keydown","scroll","touchstart","click","focus","blur"].forEach(e=>{document.addEventListener(e,resetActivityTimer,{passive:!0})}),performKeepAliveAction(),window.erpSessionInterval=e,window.erpSessionCheckInterval=o,console.log("âœ… Enhanced session keep-alive activated with monitoring")}(),updateSessionTimestamp()):(console.log("ðŸ”“ User not logged in, session keep-alive not needed"),console.log("ðŸ” Current URL:",window.location.href),console.log("ðŸ“„ Page title:",document.title),window.location.href.includes("erp.iitkgp.ac.in")&&(console.log("â³ On ERP site but login not detected, retrying in 5 seconds..."),setTimeout(()=>{initializeSessionKeepAlive()},5e3)))},1e3)}function checkIfLoggedIn(){console.log("ðŸ” Checking login status on:",window.location.href);const e=['a[href*="logout.htm"]','a[href*="/IIT_ERP3/logout.htm"]','label:contains("Welcome")','.navbar-brand:contains("ERP System")',"#moduleUL",'a[href*="menulist.htm"]'];for(const o of e)try{let e;if(o.includes(":contains(")){const[n,t]=o.split(":contains("),i=t.replace(/[()""]/g,""),s=document.querySelectorAll(n);e=Array.from(s).find(e=>e.textContent&&e.textContent.includes(i))}else e=document.querySelector(o);if(e)return console.log(`ðŸ” Found logged-in indicator: ${o}`),console.log("ðŸ“„ Element content:",e.textContent?.trim().substring(0,100)),!0}catch(e){console.log(`âš ï¸ Error checking selector ${o}:`,e)}const o=["/IIT_ERP3/menulist.htm","/IIT_ERP3/home.htm","module_id="],n=window.location.href.toLowerCase();for(const e of o)if(n.includes(e.toLowerCase()))return console.log(`ðŸ” Found logged-in URL pattern: ${e}`),!0;return document.body.textContent.includes("Welcome")&&document.body.textContent.includes("ERP")?(console.log("ðŸ” Found welcome message in page content"),!0):(console.log("âŒ No logged-in indicators found"),!1)}function performKeepAliveAction(){console.log("ðŸ“¡ Performing keep-alive ping...");try{const e=["/IIT_ERP3/home.htm","/IIT_ERP3/menulist.htm","/api/ping"];let o=0;const tryNextEndpoint=()=>{if(o>=e.length)return console.log("âš ï¸ All ERP endpoints failed, trying alternative method"),void alternativeKeepAlive();const n=e[o];o++,console.log(`ðŸ“¡ Trying endpoint ${o}/${e.length}: ${n}`),fetch(window.location.origin+n,{method:"HEAD",credentials:"include",headers:{"X-Requested-With":"XMLHttpRequest","Cache-Control":"no-cache"},signal:AbortSignal.timeout(1e4)}).then(e=>{e.ok?(console.log(`âœ… Keep-alive ping successful via ${n}`),updateSessionTimestamp()):(console.log(`âš ï¸ Endpoint ${n} returned ${e.status}, trying next...`),tryNextEndpoint())}).catch(e=>{console.log(`âš ï¸ Endpoint ${n} failed:`,e.message,"- trying next..."),tryNextEndpoint()})};tryNextEndpoint()}catch(e){console.log("âš ï¸ Keep-alive ping error, trying alternative method:",e),alternativeKeepAlive()}}function alternativeKeepAlive(){try{console.log("ðŸ”„ Using alternative keep-alive method...");const e=document.createElement("iframe");e.style.display="none",e.style.width="1px",e.style.height="1px",e.style.position="absolute",e.style.left="-9999px";const o=window.location.origin+"/IIT_ERP3/home.htm";e.src=o+"?keepalive="+Date.now();let n=!1;e.onload=()=>{n||(n=!0,console.log("âœ… Alternative keep-alive successful (iframe loaded)"),e.parentNode&&document.body.removeChild(e),updateSessionTimestamp(),setTimeout(()=>{checkIfLoggedIn()||console.warn("âš ï¸ Session may have expired despite keep-alive attempt")},2e3))},e.onerror=()=>{n||(n=!0,console.log("âš ï¸ Alternative keep-alive failed (iframe error)"),e.parentNode&&document.body.removeChild(e),performPageInteraction())},document.body.appendChild(e),setTimeout(()=>{n||(n=!0,console.log("â° Alternative keep-alive timeout"),e.parentNode&&document.body.removeChild(e),performPageInteraction())},15e3)}catch(e){console.log("âŒ Alternative keep-alive method failed:",e),performPageInteraction()}}function performPageInteraction(){try{console.log("ðŸ”„ Performing page interaction to maintain session..."),["mousemove","click","keydown"].forEach(e=>{const o=new Event(e,{bubbles:!0});document.body.dispatchEvent(o)});const e=window.pageYOffset;window.scrollTo(0,e+1),setTimeout(()=>{window.scrollTo(0,e)},100),console.log("âœ… Page interaction completed"),updateSessionTimestamp()}catch(e){console.log("âŒ Page interaction failed:",e)}}function updateSessionTimestamp(){const e={lastActivity:Date.now(),url:window.location.href,timestamp:(new Date).toISOString()};chrome.storage.local.set({[o]:e},()=>{chrome.runtime.lastError||console.log("ðŸ’¾ Session timestamp updated")})}function createLoginPrompt(){if(console.log("ðŸ“ Prompting for credentials..."),!window.location.href.includes("erp.iitkgp.ac.in"))return void console.log("âŒ Not on ERP site, skipping credential prompt");const o=prompt("ðŸ” EasyERP AutoLogin\n\nEnter your Login ID:");if(!o)return void console.log("âŒ No login ID provided, cancelling setup");const n=prompt("ðŸ” EasyERP AutoLogin\n\nEnter your Password:");if(!n)return void console.log("âŒ No password provided, cancelling setup");const t={},i=prompt("ðŸ” EasyERP AutoLogin\n\nEnter your FIRST security question:");if(!i)return void console.log("âŒ No security questions provided, cancelling setup");const s=prompt(`ðŸ” EasyERP AutoLogin\n\nAnswer to: "${i}"`);if(!s)return void console.log("âŒ No answer provided, cancelling setup");t[i]=s;const l=prompt("ðŸ” EasyERP AutoLogin\n\nEnter your SECOND security question:");if(!l)return void console.log("âŒ No second security question provided, cancelling setup");const r=prompt(`ðŸ” EasyERP AutoLogin\n\nAnswer to: "${l}"`);if(!r)return void console.log("âŒ No answer provided, cancelling setup");t[l]=r;const c=prompt("ðŸ” EasyERP AutoLogin\n\nEnter your THIRD security question:");if(!c)return void console.log("âŒ No third security question provided, cancelling setup");const a=prompt(`ðŸ” EasyERP AutoLogin\n\nAnswer to: "${c}"`);if(!a)return void console.log("âŒ No answer provided, cancelling setup");t[c]=a;const g={loginId:o,password:n,questions:t};console.log("ðŸ’¾ Saving credentials to storage..."),chrome.storage.local.set({[e]:g},()=>{chrome.runtime.lastError?(console.error("âŒ Error saving credentials:",chrome.runtime.lastError),alert("âŒ Error saving credentials. Please try again.")):(console.log("âœ… Credentials saved successfully!"),alert("âœ… Credentials saved! Please reload the page to start auto-login."))})}function initializeExtension(){console.log("ðŸ” Checking for stored credentials..."),chrome.storage.local.get([e],o=>{chrome.runtime.lastError?console.error("âŒ Error accessing storage:",chrome.runtime.lastError):(console.log("ðŸ“¦ Storage result:",o),o[e]&&0!==Object.keys(o[e]||{}).length?(console.log("âœ… Credentials found, starting auto-login..."),console.log("ðŸ”‘ Stored credentials:",{loginId:o[e].loginId?"***":"missing",password:o[e].password?"***":"missing",questions:Object.keys(o[e].questions||{}).length+" questions"}),setTimeout(()=>{!function(o){console.log("ðŸš€ Starting auto-login process...");const n=document.querySelector('input[name="user_id"]'),t=document.querySelector('input[name="password"]'),i=document.querySelector('input[name="email_otp"]');if(!n||!t)return console.error("âŒ Login or password field not found on page"),void console.log("ðŸ” Available input fields:",document.querySelectorAll("input"));console.log("âœ… Login fields found, proceeding with auto-fill"),console.log("ðŸ‘¤ Step 1: Filling login ID..."),n.focus(),n.value=o.loginId,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),setTimeout(()=>{console.log("ðŸ”‘ Step 2: Filling password..."),t.focus(),t.value=o.password,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.blur(),console.log("â“ Step 3: Waiting for security question to appear...");const n=new MutationObserver(()=>{const t=document.querySelector('input[name="answer"]'),s=document.querySelector("label#question");if(t&&s&&null!==t.offsetParent){const l=s.textContent.trim(),r=o.questions[l];if(!r){console.warn("âš ï¸ No answer found for question:",l);const n=prompt(`â“ Security Question:\n\n${l}\n\nPlease provide the answer:`);n&&(o.questions[l]=n,chrome.storage.local.set({[e]:o})),r=n}if(r){console.log(`âœ… Step 4: Filling security answer for: ${l}`),t.focus(),t.value=r,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.blur(),n.disconnect();const e=document.querySelector("#getotp");e?(console.log("ðŸ“± Step 5: Clicking Send OTP..."),e.click()):console.warn("âš ï¸ Send OTP button not found"),setTimeout(()=>{const e=prompt("ðŸ“± EasyERP AutoLogin\n\nStep 6: Enter the 6-digit OTP sent to your email:");if(i&&e){console.log("ðŸ”¢ Step 7: Filling OTP..."),i.value=e,i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}));const o=document.querySelector("#loginFormSubmitButton");if(o){console.log("ðŸš€ Step 8: Clicking Login button..."),o.click(),console.log("â³ Monitoring for successful login and page redirect...");let e=0;const n=20,checkLoginSuccess=()=>{if(e++,console.log(`ðŸ” Login check ${e}/${n} - URL: ${window.location.href}`),window.location.href.includes("menulist.htm")||window.location.href.includes("home.htm")||checkIfLoggedIn())return console.log("âœ… Login successful! Starting session management..."),void setTimeout(()=>{initializeSessionKeepAlive()},2e3);e<n?setTimeout(checkLoginSuccess,1e3):(console.warn("âš ï¸ Login success check timed out. Trying session setup anyway..."),setTimeout(()=>{initializeSessionKeepAlive()},1e3))};setTimeout(checkLoginSuccess,2e3)}else console.warn("âš ï¸ Login submit button not found")}else console.log("âŒ OTP entry cancelled or field not found")},2e3)}}});n.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{n.disconnect(),console.log("â° Security question observer timed out after 30 seconds")},3e4)},1200)}(o[e])},500)):(console.log("ðŸ“ No credentials found, prompting user..."),setTimeout(()=>{createLoginPrompt()},1e3)))})}console.log("ðŸš€ EasyERP AutoLogin script loaded!"),window.EasyERPAutoLogin={setupCredentials:createLoginPrompt,clearCredentials:()=>{chrome.storage.local.remove([e],()=>{console.log("ðŸ—‘ï¸ Credentials cleared!"),alert("Credentials cleared! Reload page to set up new credentials.")})},viewCredentials:()=>{chrome.storage.local.get([e],o=>{o[e]?console.log("ðŸ”‘ Current credentials:",{loginId:o[e].loginId,password:"***HIDDEN***",questions:o[e].questions}):console.log("âŒ No credentials stored")})},startSessionKeepAlive:()=>{console.log("ðŸ”§ Manually starting session keep-alive..."),initializeSessionKeepAlive()},checkLoginStatus:()=>{console.log("ðŸ”§ Manual login status check...");const e=checkIfLoggedIn();return console.log("Login status:",e?"âœ… LOGGED IN":"âŒ NOT LOGGED IN"),e},performKeepAlive:()=>{console.log("ðŸ”§ Manual keep-alive ping..."),performKeepAliveAction()},sessionStatus:()=>{console.log("ðŸ”§ Session management status:"),console.log("- Keep-alive interval:",window.erpSessionInterval?"âœ… ACTIVE":"âŒ INACTIVE"),console.log("- Session check interval:",window.erpSessionCheckInterval?"âœ… ACTIVE":"âŒ INACTIVE"),console.log("- Current URL:",window.location.href),console.log("- Login status:",checkIfLoggedIn()?"âœ… LOGGED IN":"âŒ NOT LOGGED IN")}},console.log("ðŸŽ® Debug commands available:"),console.log("- EasyERPAutoLogin.setupCredentials() - Setup new credentials"),console.log("- EasyERPAutoLogin.clearCredentials() - Clear stored credentials"),console.log("- EasyERPAutoLogin.viewCredentials() - View current credentials"),console.log("- EasyERPAutoLogin.startSessionKeepAlive() - Manually start session management"),console.log("- EasyERPAutoLogin.checkLoginStatus() - Check if currently logged in"),console.log("- EasyERPAutoLogin.performKeepAlive() - Manual keep-alive ping"),console.log("- EasyERPAutoLogin.sessionStatus() - View session management status"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeExtension):initializeExtension(),setTimeout(()=>{window.location.href.includes("erp.iitkgp.ac.in")&&(window.location.href.includes("menulist.htm")||window.location.href.includes("home.htm")||checkIfLoggedIn())&&(console.log("ðŸ” Detected logged-in ERP page, ensuring session management is active..."),window.erpSessionInterval?console.log("âœ… Session management already active"):(console.log("âš¡ Starting session management for logged-in page..."),initializeSessionKeepAlive()))},3e3);let n=window.location.href;setInterval(()=>{window.location.href!==n&&(n=window.location.href,console.log("ðŸŒ URL changed to:",n),n.includes("erp.iitkgp.ac.in")&&(n.includes("menulist.htm")||n.includes("home.htm"))&&!window.erpSessionInterval&&(console.log("âš¡ Navigation to logged-in page detected, starting session management..."),setTimeout(()=>{initializeSessionKeepAlive()},1e3)))},2e3)}();